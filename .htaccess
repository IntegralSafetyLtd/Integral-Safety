# Integral Safety - URL Rewriting and Security
# Apache/LiteSpeed Configuration

# Enable Rewrite Engine
RewriteEngine On

# =============================================
# 301 Redirects - Old URLs to New Structure
# =============================================

# Old training course URLs (root level → /training/)
RewriteRule ^coshh-awareness/?$ /training/coshh-awareness/ [R=301,L]
RewriteRule ^iosh-managing-safely/?$ /training/iosh-managing-safely/ [R=301,L]
RewriteRule ^fire-awareness/?$ /training/fire-awareness/ [R=301,L]
RewriteRule ^manual-handling/?$ /training/manual-handling/ [R=301,L]
RewriteRule ^sharps-awareness/?$ /training/sharps-awareness/ [R=301,L]
RewriteRule ^accident-investigation/?$ /training/accident-investigation/ [R=301,L]

# Old service URLs (root level → /services/)
RewriteRule ^fire-risk-assessments/?$ /services/fire-risk-assessments/ [R=301,L]
RewriteRule ^face-fit-testing/?$ /services/face-fit-testing/ [R=301,L]
RewriteRule ^drone-surveys/?$ /services/work-at-height-surveys/ [R=301,L]
RewriteRule ^work-at-height-surveys/?$ /services/work-at-height-surveys/ [R=301,L]
RewriteRule ^consultancy/?$ /services/consultancy/ [R=301,L]
RewriteRule ^auditing/?$ /services/auditing/ [R=301,L]
RewriteRule ^competent-person/?$ /services/competent-person/ [R=301,L]
RewriteRule ^havs-testing/?$ /services/havs-testing/ [R=301,L]
RewriteRule ^accreditation-support/?$ /services/accreditation-support/ [R=301,L]

# Old page URLs
RewriteRule ^contact-us/?$ /contact/ [R=301,L]
RewriteRule ^health-and-safety-training/?$ /training/ [R=301,L]
RewriteRule ^health-and-safety-consultancy-service/?$ /services/consultancy/ [R=301,L]
RewriteRule ^health-safety-competent-person-services/?$ /services/competent-person/ [R=301,L]
RewriteRule ^leicestershire-health-and-safety-consultant/?$ / [R=301,L]
RewriteRule ^health-safety-services-in-melton-mowbray/?$ / [R=301,L]
RewriteRule ^housing-association-and-almshouses/?$ / [R=301,L]

# =============================================

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Remove www (optional - uncomment if needed)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Prevent directory browsing
Options -Indexes

# Block access to sensitive files
<FilesMatch "^(config\.php|\.env|\.htaccess|database_schema\.sql)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Protect uploads directory from PHP execution
<Directory "uploads">
    <FilesMatch "\.php$">
        Order allow,deny
        Deny from all
    </FilesMatch>
</Directory>

# Protect content directory
<Directory "content">
    Order allow,deny
    Deny from all
</Directory>

# Dynamic robots.txt
RewriteRule ^robots\.txt$ robots.php [L]

# Clean URLs - Blog
RewriteRule ^blog/?$ blog.php [L,QSA]
RewriteRule ^blog/([a-z0-9-]+)/?$ blog-post.php?slug=$1 [L,QSA]

# Clean URLs - Services
RewriteRule ^services/?$ services.php [L,QSA]
RewriteRule ^services/([a-z0-9-]+)/?$ service.php?slug=$1 [L,QSA]

# Clean URLs - Training
RewriteRule ^training/?$ training.php [L,QSA]
RewriteRule ^training/([a-z0-9-]+)/?$ training-single.php?slug=$1 [L,QSA]

# Clean URLs - Static Pages
RewriteRule ^about/?$ about.php [L,QSA]
RewriteRule ^contact/?$ contact.php [L,QSA]
RewriteRule ^privacy/?$ privacy.php [L,QSA]
RewriteRule ^terms/?$ terms.php [L,QSA]

# Clean URLs - Location Pages
RewriteRule ^(health-and-safety-consultants-leicester)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-consultants-nottingham)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-consultants-derby)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-consultants-loughborough)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-east-midlands)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(fire-risk-assessments-leicester)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(fire-risk-assessments-nottingham)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(fire-risk-assessments-derby)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(fire-risk-assessments-loughborough)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(fire-risk-assessments-east-midlands)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-training-leicester)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-training-nottingham)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-training-derby)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-training-loughborough)/?$ location.php?slug=$1 [L,QSA]
RewriteRule ^(health-and-safety-training-east-midlands)/?$ location.php?slug=$1 [L,QSA]

# Admin area (no rewriting needed, direct access)
# /admin/ works as-is

# Handle 404 errors
ErrorDocument 404 /404.php

# Caching for static assets (1 year for versioned files)
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/avif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
</IfModule>

# Gzip compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css application/javascript application/json
</IfModule>

# Security Headers
<IfModule mod_headers.c>
    Header set X-Content-Type-Options "nosniff"
    Header set X-Frame-Options "SAMEORIGIN"
    Header set X-XSS-Protection "1; mode=block"
    Header set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>
